var deviceStates={};var readings={STATE:true};var devices={};var types=[];var DEBUG=false;var DEMO=false;var debuglevel;var TOAST=true;var doLongPoll=false;var longPollRequest;var shortPollTimer;var longPollTimer;var dir="";var fhem_dir="";var filename="";var shortpollInterval=30*1000;var devs=[];var pars=[];var gridster;var styleCollection={};var stdColors=["green","orange","red","ligthblue","blue","gray"];var plugins={modules:[],addModule:function(a){this.modules.push(a)},load:function(name){return loadplugin(name,function(){var module=eval(name);plugins.addModule(module);module.init();for(var device in devices){var params=deviceStates[device];for(var reading in params){if(readings[reading]){module.update(device,reading)}}}for(var reading in readings){if(pars.indexOf(reading)<0){pars.push(reading)}}DEBUG&&console.log("Loaded plugin: "+name)},null,true)},update:function(a,b){$.each(this.modules,function(c,d){d.update(a,b)});DEBUG&&console.log("update done for device:"+a+" parameter:"+b)}};var ftui={requests:{waiting:0,running:0,waitTime:100,maxRunning:4},states:{lastSetOnline:0,longPollRestart:false},paramIdMap:{},timestampMap:{},init:function(){},initPage:function(){initPage()},shortPoll:function(){var a=null;ftui.log(1,"start shortpoll");for(var b in devices){var c=deviceStates[b];for(a in c){c[a].valid=false}}ftui.requests.waiting=Object.keys(readings).length;ftui.requests.length=ftui.requests.waiting;ftui.requests.startTime=new Date();ftui.log(1,"shortPoll - waiting requests:"+ftui.requests.waiting);for(a in readings){requestFhem(a)}},decreaseRequests:function(a){ftui.requests.waiting--;if(ftui.requests.waiting===0){var b=diffSeconds(ftui.requests.startTime,new Date());if(DEBUG){ftui.toast("Full refresh done in "+b+"s for "+ftui.requests.length+" readings")}ftui.log(1,"shortPoll - Done");ftui.onUpdateDone()}},onUpdateDone:function(){$(document).trigger("updateDone");ftui.checkInvalidElements()},checkInvalidElements:function(){$("div.autohide[data-get]").each(function(a){var c=$(this);var b=c.getReading("get").valid;if(b&&b===true){c.removeClass("invalid")}else{c.addClass("invalid")}})},setOnline:function(){var a=new Date().getTime()/1000;if((a-ftui.states.lastSetOnline)>60){if(DEBUG){ftui.toast("Network connected")}ftui.states.lastSetOnline=a;startShortPollInterval(500);if(!doLongPoll){doLongPoll=($("meta[name='longpoll']").attr("content")=="1");if(doLongPoll){startLongPollInterval(5000)}}ftui.log(1,"FTUI is online")}},setOffline:function(){if(DEBUG){ftui.toast("Lost network connection")}doLongPoll=false;clearInterval(shortPollTimer);clearInterval(longPollTimer);if(longPollRequest){longPollRequest.abort()}ftui.saveStatesLocal();ftui.log(1,"FTUI is offline")},saveStatesLocal:function(){var a=JSON.stringify(deviceStates);localStorage.setItem("deviceStates",a)},restartLongPoll:function(){ftui.toast("Disconnected from FHEM");if(doLongPoll){ftui.toast("Retry to connect in 10 seconds");setTimeout(function(){longPoll()},10000)}},toast:function(a){if(TOAST){$.toast(a)}},log:function(b,a){if(debuglevel>=b){console.log(a)}}};$(document).on("ready",function(){ftui.init();$(ftui).on("shortpollfinished",function(){$.toast("shortpollfinished")});$("<div id='shade' />").prependTo("body").hide();$("#shade").on("click",function(){$(document).trigger("shadeClicked")});loadStyleSchema();initPage();if(doLongPoll){var a=$("meta[name='longpoll_delay']").attr("content");if(!$.isNumeric(a)){a=(typeof wvcDevices!="undefined")?shortpollInterval:100}startLongPollInterval(a)}$("*:not(select)").focus(function(){$(this).blur()});startShortPollInterval()});function initPage(){wx=parseInt($("meta[name='widget_base_width']").attr("content"));wy=parseInt($("meta[name='widget_base_height']").attr("content"));if($("meta[name='widget_margin']").attr("content")){wm=parseInt($("meta[name='widget_margin']").attr("content"))}else{wm=5}doLongPoll=($("meta[name='longpoll']").attr("content")=="1");DEMO=($("meta[name='demo']").attr("content")=="1");debuglevel=$("meta[name='debug']").attr("content")||0;DEBUG=(debuglevel>0);TOAST=($("meta[name='toast']").attr("content")!="0");dir=$('script[src*="fhem-tablet-ui"]').attr("src");var b=dir.split("/").pop();dir=dir.replace("/"+b,"");DEBUG&&console.log("Plugin dir: "+dir);var a=window.location.pathname;filename=a.substring(a.lastIndexOf("/")+1);DEBUG&&console.log("Filename: "+filename);fhem_dir=$("meta[name='fhemweb_url']").attr("content")||"/fhem/";DEBUG&&console.log("FHEM dir: "+fhem_dir);if($.fn.gridster){if(gridster){gridster.destroy()}gridster=$(".gridster > ul").gridster({widget_base_dimensions:[wx,wy],widget_margins:[wm,wm],draggable:{handle:".gridster li > header"}}).data("gridster");if($("meta[name='gridster_disable']").attr("content")=="1"){gridster.disable()}if($("meta[name='gridster_starthidden']").attr("content")=="1"){$(".gridster").hide()}}var c=$("[data-template]").length;if(c>0){$("[data-template]").each(function(d){var e=$(this);$.get(e.data("template"),{},function(h){var f=e.data("parameter");for(var g in f){h=h.replace(new RegExp(g,"g"),f[g])}e.html(h);if(d===c-1){initWidgets()}})})}else{initWidgets()}}function initReadingsArray(c){if(!$.isArray(c)){c=new Array(c)}for(var e=0;e<c.length;e++){var b=c[e];if(b.match(/:/)){var a=b.split(":");var d=a[0];if(!devices[d]&&typeof d!="undefined"&&d!=="undefined"){devices[d]=true;devs.push(d)}b=a[1]}if(!readings[b]&&!b.match(/^[#\.\[].*/)){readings[b]=true;pars.push(b)}}}function initWidgets(b){b=(typeof b!=="undefined")?b:"";readings={STATE:true};devices={};types=[];devs=[];pars=[];if(!DEMO){deviceStates=JSON.parse(localStorage.getItem("deviceStates"))||{}}else{$.ajax({async:false,url:"/fhem/tablet/data/"+filename.replace(".html",".dat")}).done(function(c){deviceStates=JSON.parse(c)||{}})}showDeprecationMsg();$(b+" div[data-type]").each(function(c){var d=$(this).data("type");if(types.indexOf(d)<0){types.push(d)}});$(b+" div[data-device]").each(function(c){var d=$(this).data("device");if(!d.match(/^[#\.\[].*/)){if(!devices[d]&&typeof d!="undefined"&&d!=="undefined"){devices[d]=true;devs.push(d)}}});DEBUG&&console.log("Collecting required readings");$(b+" [data-get]").each(function(c){var d=$(this).data("get");initReadingsArray(d)});var a=$.map(types,function(d,c){return plugins.load("widget_"+d)});$.when.apply(this,a).then(function(){DEBUG&&console.log("Request readings from FHEM");ftui.shortPoll()})}function showDeprecationMsg(){}function startShortPollInterval(a){clearInterval(shortPollTimer);shortPollTimer=setTimeout(function(){ftui.shortPoll();startShortPollInterval()},a||shortpollInterval)}function startLongPollInterval(a){if(DEBUG){ftui.toast("Start Longpoll in "+a/1000+"s")}clearInterval(longPollTimer);longPollTimer=setTimeout(function(){longPoll()},a);shortpollInterval=15*60*1000}function setFhemStatus(a){if(DEMO){console.log("DEMO-Mode: no setFhemStatus");return}startShortPollInterval();a=a.replace("  "," ");DEBUG&&console.log("send to FHEM: "+a);$.ajax({async:true,cache:false,url:fhem_dir,data:{cmd:a,XHR:"1"}}).fail(function(b,d,c){TOAST&&$.toast("Error: "+d+": "+c)}).done(function(b){if(!doLongPoll){setTimeout(function(){ftui.shortPoll()},4000)}})}var xhr;var currLine=0;function longPoll(a){if(DEMO){console.log("DEMO-Mode: no longpoll");return}ftui.log(1,(ftui.states.longPollRestart)?"Longpoll re-started":"Longpoll started");if(xhr){xhr.abort()}if(longPollRequest){longPollRequest.abort()}currLine=0;if(DEBUG){if(ftui.states.longPollRestart){ftui.toast("Longpoll re-started")}else{ftui.toast("Longpoll started")}}ftui.states.longPollRestart=0;longPollRequest=$.ajax({url:fhem_dir,cache:false,async:true,data:{XHR:1,inform:"type=raw;filter=.*"},xhr:function(){xhr=new window.XMLHttpRequest();xhr.addEventListener("readystatechange",function(p){var k=p.target.responseText;if(p.target.readyState==4){return}if(p.target.readyState==3){var t=k.replace(/<br>/g,"").split(/\n/);var h=/\s[0-2][0-9]:[0-5][0-9]:[0-5][0-9]\.?[0-9]{0,3}\s(\S*)\s(\S*)\s(.*)/;var n=/^([0-9]{4}-[0-9]{2}-[0-9]{2}\s[0-2][0-9]:[0-5][0-9]:[0-5][0-9])\.?[0-9]{0,3}\s/;var d=/^(\S{2,}):(?:\s(.*))?$/;t.pop();for(var l=currLine,o=t.length;l<o;l++){var g;var s=$.trim(t[l]);if(n.test(s)){g=$.trim(s.match(n)[1])}if(h.test(s)){var b=$.trim(s.match(h)[1]);var m=$.trim(s.match(h)[2]);var r=$.trim(s.match(h)[3]);var j=deviceStates[m]||{};var c;var f;if(d.test(r)){var c=$.trim(r.match(d)[1]);var f=$.trim(r.match(d)[2])}else{var c="STATE";var f=r}if(((b=="readingsGroup")&&(m in devices))||((c in readings)&&(m in devices))){var q={date:g,room:b,val:f,valid:true};j[c]=q;deviceStates[m]=j;DEBUG&&console.log(g+" / "+m+" / "+c+" / "+f);plugins.update(m,c)}}}currLine=t.length;if(currLine>1024){ftui.states.longPollRestart=true;longPollRequest.abort()}}},false);return xhr}}).done(function(b){if(ftui.states.longPollRestart){longPoll(a)}else{ftui.log(1,"Disconnected from FHEM - poll done - "+b);ftui.restartLongPoll()}}).fail(function(b,d,c){if(ftui.states.longPollRestart){longPoll(a)}else{ftui.log(1,"Error while longpoll: "+d+": "+c);ftui.restartLongPoll()}})}function requestFhem(b,d){if(DEMO){console.log("DEMO-Mode: no requestFhem");return}var a;if(b.match(/:/)){var c=b.split(":");d=c[0];b=c[1]}if(typeof d!="undefined"&&d!=="undefined"){a=d}else{a=$.map(devs,$.trim).join()}if(ftui.requests.running>ftui.requests.maxRunning){setTimeout(function(){requestFhem(b,d)},ftui.requests.waitTime)}else{ftui.log(5,"starting new AJAX. still running:"+ftui.requests.running);if(typeof b!="undefined"&&b!=="undefined"&&b!==""&&typeof a!="undefined"&&a!=="undefined"&&a!==""){ftui.requests.running++;$.ajax({async:true,timeout:15000,cache:false,context:{paraname:b},url:fhem_dir,data:{cmd:["list",a,b].join(" "),XHR:"1"},beforeSend:function(f,e){f.url=e.url},error:function(f,e){}}).fail(function(e,g,f){if(DEBUG){ftui.toast("Error: "+g+": "+f+": "+ftui.requests.running)}ftui.requests.running--;ftui.decreaseRequests()}).done(function(l){ftui.requests.running--;if(debuglevel>=5){console.log("finished AJAX request. still running:"+ftui.requests.running)}var e=this.paraname;var s=l.replace(/\n\)/g,")\n").split(/\n/);var p=/^(\S*)\s*([0-9]{4}-[0-9]{2}-[0-9]{2}\s[0-2][0-9]:[0-5][0-9]:[0-5][0-9])?\.?[0-9]{0,3}\s+(.*)$/;for(var m=0,o=s.length;m<o;m++){var h="";var n="";var g="";var r=$.trim(s[m]);if(debuglevel>=6){console.log("line: "+r)}if(p.test(r)){var f=r.match(p);n=$.trim(r.match(p)[1]);if(n in devices){if(f.length>2){h=$.trim(f[2]);g=$.trim(f[3])}if(debuglevel>=5){console.log("requestFhem::done: Line parser result: dev:"+n+" paraname:"+e+" date:"+h+" val:"+g)}var k=getParameterByName(n,e);var j=deviceStates[n]||{};var q={date:h,val:g,valid:true};j[e]=q;deviceStates[n]=j;if(!k||k.val!=g||k.date!=h){plugins.update(n,e)}}}}ftui.decreaseRequests()})}}}$(window).on("beforeunload",function(){ftui.log(5,"beforeunload");ftui.setOffline()});$(window).on("online offline",function(){ftui.log(5,"online offline");if(navigator.onLine){ftui.setOnline()}else{ftui.setOffline()}});function loadplugin(c,d,a,b){return dynamicload("js/"+c+".js",d,a,b)}function dynamicload(c,e,b,d){var a=(DEBUG)?false:true;return $.ajax({url:dir+"/../"+c,dataType:"script",cache:a,async:d||false,context:{name:name},success:e||function(){return true},error:b||function(){return false}})}function loadStyleSchema(){$.each($('link[href$="-ui.css"],link[href$="-ui.min.css"]'),function(e,b){if(!b||!b.sheet||!b.sheet.cssRules){return}var f=b.sheet.cssRules;for(var a in f){if(f[a].style){var h=f[a].style.cssText.split(";");h.pop();var g=f[a].selectorText;var d={};for(var i in h){var c=h[i].toString().split(":");if(c[0].match(/color/)){d[$.trim(c[0])]=$.trim(c[1]).replace("! important","").replace("!important","")}}if(Object.keys(d).length>0){styleCollection[g]=d}}}})}this.getPart=function(d,f){if($.isNumeric(f)){var g=(d&&typeof d!="undefined")?d.split(" "):"";return(g.length>=f&&f>0)?g[f-1]:d}else{if((d&&typeof d!="undefined")){var e=d.match(new RegExp("^"+f+"$"))}var a="";if(e){for(var b=1;b<e.length;b++){a+=e[b]}}return a}};this.getDeviceValueByName=function(b,a){var c=getParameterByName(b,a);return(c)?c.val:null};this.getDeviceValue=function(a,c){var b=getParameter(a,c);return(b)?b.val:null};this.getReadingDateByName=function(b,a){var c=getParameterByName(b,a);return(c)?c.date:null};this.getReadingDate=function(a,c){var b=getParameter(a,c);return(b)?b.date:null};this.getParameterByName=function(c,a){if(c.match(/:/)){var b=c.split(":");c=b[0];a=b[1]}a=a||Object.keys(readings)[0];if(c&&c.length>0){var d=deviceStates[c];return(d&&d[a])?d[a]:null}return null};this.getParameter=function(c,e){var b=c.data("device");var a=(e&&e!="")?c.data(e):Object.keys(readings)[0];if(b&&b.length>0){var d=deviceStates[b];return(d&&d[a])?d[a]:null}return null};this.hasSubscription=function(f,a){var c=f.data("get");if(!$.isArray(c)){c=new Array(c)}var d;if(a.match(/,/)){d=a.split(",")}else{d=new Array(a)}for(var e=0;e<c.length;e++){for(var h=0;h<d.length;h++){var b;if(c[e]&&c[e].match(/:/)){b=c[e].split(":")[1]}else{b=c[e]}if(d[h]==b){return true}}}return false};this.getStyle=function(a,c){var b=styleCollection[a];return(b&&b[c])?b[c]:null};this.getClassColor=function(c){for(var b=0,a=stdColors.length;b<a;b++){if(c.hasClass(stdColors[b])){return getStyle("."+stdColors[b],"color")}}return null};this.getIconId=function(d){if(!d||d==""){return"?"}var b=$('link[href$="font-awesome.min.css"]')[0].sheet.cssRules;for(var a in b){if(b[a].selectorText&&b[a].selectorText.match(new RegExp(d+":"))){var c=b[a].style.content;if(!c){return d}c=c.replace(/"/g,"").replace(/'/g,"");return(/[^\u0000-\u00ff]/.test(c))?c:String.fromCharCode(parseInt(c.replace("\\",""),16))}}};this.isValid=function(a){return(typeof a!=="undefined"&&a!=="undefined"&&typeof a!==typeof notusedvar&&a!==""&&a!==" ")};this.showModal=function(a){if(a){$("#shade").fadeIn()}else{$("#shade").fadeOut()}};this.dateFromString=function(d){var a=d.match(/(\d+)-(\d+)-(\d+)[_\s](\d+):(\d+):(\d+).*/);var b=d.match(/(\d\d).(\d\d).(\d\d\d\d)/);var c=new Date().getTimezoneOffset();return(a)?new Date(+a[1],+a[2]-1,+a[3],+a[4],+a[5],+a[6]):(b)?new Date(+b[3],+b[2]-1,+b[1],0,-c,0,0):new Date()};this.diffMinutes=function(c,a){var b=new Date(a-c);return(b/1000/60).toFixed(0)};this.diffSeconds=function(c,a){var b=new Date(a-c);return(b/1000).toFixed(1)};this.mapColor=function(a){return getStyle("."+a,"color")||a};String.prototype.toDate=function(){return dateFromString(this)};Date.prototype.addMinutes=function(a){return new Date(this.getTime()+a*60000)};Date.prototype.ago=function(){var b=new Date();var a=(b-this);var g=a/1000;var h=Math.round(g%60);g/=60;var c=Math.round(g%60);g/=60;var f=Math.round(g%24);g/=24;var j=Math.round(g);var i=navigator.language||navigator.userLanguage;var d=(i.split("-")[0]==="de")?["Tage","Stunden","Minuten","Sekunden"]:["days","hours","minutes","seconds"];var e=(j>0)?j+" "+d[0]+" ":"";e+=(f>0)?f+" "+d[1]+" ":"";e+=(c>0)?c+" "+d[2]+" ":"";return e+h+" "+d[3]};Date.prototype.yyyymmdd=function(){var c=this.getFullYear().toString();var b=(this.getMonth()+1).toString();var a=this.getDate().toString();return c+"-"+(b[1]?b:"0"+b[0])+"-"+(a[1]?a:"0"+a[0])};Date.prototype.hhmm=function(){var a=this.getHours().toString();var b=this.getMinutes().toString();return(a[1]?a:"0"+a[0])+":"+(b[1]?b:"0"+b[0])};Date.prototype.hhmmss=function(){var b=this.getHours().toString();var c=this.getMinutes().toString();var a=this.getSeconds().toString();return(b[1]?b:"0"+b[0])+":"+(c[1]?c:"0"+c[0])+":"+(a[1]?a:"0"+a[0])};Date.prototype.ddmm=function(){var b=(this.getMonth()+1).toString();var a=this.getDate().toString();return(a[1]?a:"0"+a[0])+"."+(b[1]?b:"0"+b[0])+"."};Date.prototype.eeee=function(){var c=["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"];var b=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];var a=navigator.language||navigator.userLanguage;if(a.split("-")[0]==="de"){return c[this.getDay()]}return b[this.getDay()]};Date.prototype.eee=function(){var c=["Son","Mon","Die","Mit","Don","Fre","Sam"];var b=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];var a=navigator.language||navigator.userLanguage;if(a.split("-")[0]==="de"){return c[this.getDay()]}return b[this.getDay()]};Date.prototype.ee=function(){var c=["So","Mo","Di","Mi","Do","Fr","Sa"];var b=["Su","Mo","Tu","We","Th","Fr","Sa"];var a=navigator.language||navigator.userLanguage;if(a.split("-")[0]==="de"){return c[this.getDay()]}return b[this.getDay()]};this.indexOfGeneric=function(c,b){if(!c){return -1}for(var a=0;a<c.length;a++){if(!$.isNumeric(c[a])){return indexOfRegex(c,b)}}return indexOfNumeric(c,b)};this.indexOfNumeric=function(d,c){var a=-1;for(var b=0;b<d.length;b++){if(Number(c)>=Number(d[b])){a=b}}return a};this.indexOfRegex=function(f,d){for(var b=0;b<f.length;b++){try{var a=d.match(new RegExp("^"+f[b]+"$"));if(a){return b}}catch(c){}}return f.indexOf(d)};$.fn.once=function(d,c){return this.each(function(){$(this).off(d).on(d,c)})};